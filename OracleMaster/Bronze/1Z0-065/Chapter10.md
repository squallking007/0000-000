# 第十章 データベースの監視およびアドバイザの使用

## 10.1 Oracle自己監視アーキテクチャ

**Oracle自己診断エンジン　★★★★**

- Oracleデータベースには、`ADDM(自動データベース診断モニター)`と呼ばれる自己診断エンジンが搭載されている。

- `ADDM`は、データベース自身によって自動的に実行されている。

- `ADDM`によるパフォーマンス診断は「メトリック」に基づいて行われる。

- `メトリック`とは「すでに定義されている特定のシステム属性の統計セット」。

- `EM Express`を使用すると、データベースの状態やワークロードを監視できる。

- `EM Express`の「データベース・ホーム」ページで確認できる情報

|セクション |表示内容 |
|---- |---- |
|ステータス |データベースの状態の概要 |
|パフォーマンス |アクティブセッションの情報。過去の傾向情報が表示される |
|リソース |最新のデータポイント(過去１分間)のリソースの使用率 |
|SQL監視 |SQLのアクティビティ |

- `ADDM`が提示する推奨事項

|推奨事項 |詳細 |
|---- |---- |
|ハードウェアの変更 |CPUの追加<br>I/Oサブシステム構成の変更 |
|データベース構成 |初期化パラメータの変更 |
|スキーマの変更 |表または索引のハッシュパーティション化<br>自動セグメント領域管理の使用 |
|アプリケーションの変更 |SEQUNCEキャッシュの使用<br>バインド変数の使用 |
|ほかのアドバイザの使用 |SQLチューニングアドバイザの実行<br>セグメントアドバイザの実行 |

## 10.2 パフォーマンスの問題の診断

**AWR(自動ワークロードリポジトリ)　★★★**

- Oracleデータベースは、データベースの状態とワークロードの情報を、定期的に`スナップショット`の形式で収集している。これを「`AWRスナップショット`」と呼ぶ。

- `AWRスナップショット`は「任意の時点のシステム状態に関する統計サマリーのデータ」です。`MMON`バックグラウンドプロセスによって、**60分ごと**に収集され、`は、SYSAUX表領域`に存在する`AWR`(自動ワークロードリポジトリ)に格納される。

- `AWR`(自動ワークロードリポジトリ)は、データベースの使用状況の履歴をデータベースに提供する情報源となっている。

- `スナップショット`の間隔は`Enterprise Manager Cloud Control`や`PL/SQLパッケージ`で変更できる。

**ADDM(自動データベース診断モニター)　★★★**

- `ADDM(自動データベース診断モニター)`は「データベース全体のアドバイザ」といえる機能です。

- `ADDM`は、`AWR`によって`スナップショット`が取得された後、それを元に６０分ごとにトップダウンシステム分析を行い、分析結果を`AWR`に格納する。分析結果には**問題の説明**と**推奨操作**が含まれる。

- デフォルトでは「`スナップショット`の保存」の期間は**８日間**、「`スナップショット`収集」の間隔は**60分に１回**に設定される。

- **スナップショットの保存期間**や**スナップショット取得の間隔**を変更することによって`ADDM`の精度に影響を及ばすことがある。

**アドバイザの使用　★★★**

- データベースでは、`アドバイザ`によって、さまざまなデータベース管理の問題の解決に対し、適切な`アドバイス`が提供される。

- `ADDM`はデータベース全体についての`アドバイザ`である。

- `パフォーマンスアドバイザ`には、`ADDM`、`SQLチューニングアドバイザ`、`メモリーアドバイザ`、`SGAアドバイザ`、`PGAアドバイザ`、`バッファキャッシュアドバイザ`などがある。

|アドバイザ名 |説明 |
|---- |---- |
|ADDM |データベース全体に関するアドバイザ |
|SQLチューニングアドバイザ |１つ以上のSQL文を分析して、パフォーマンスを改善するための推奨事項を提示する |
|メモリーアドバイザ |Oracleインスタンスに割り当てるターゲットメモリー容量の設定に関するアドバイザを提示する。<br>自動メモリー管理が有効な場合に使用できる |
|SGAアドバイザ |SGAのターゲットサイズの構成に関するアドバイザを提示する。<br>自動共有メモリー管理が有効な場合に使用できる |
|PGAアドバイザ |インスタンスPGAのテーゲットサイズの構成に関するアドバイザを提示する。<br>自動共有メモリー管理、手動共有メモリー管理が有効な場合に使用できる |
|バッファキャッシュアドバイザ |バッファキャッシュのサイズ設定に関するアドバイザを提示する。<br>手動共有メモリー管理が有効な場合に使用できる |

- `パフォーマンス`以外の`アドバイザ`として分類されるものとして、`セグメントアドバイザ`、`UNDOアドバイザ`、`MTTRアドバイザ`などがある。

|アドバイザ名 |説明 |
|---- |---- |
|セグメントアドバイザ |セグメント内の領域の断片化のラベルにきづいて、そのセグメントの縮小操作が必要か否かのアドバイスを提示する |
|UNDOアドバイザ |システムアクティビティの統計情報や、最も時間のかかる問合せの時間、UNDO保存期間の低しきい値(最小UNDO保存期間)に基づいて、UNDO表領域のサイズ設定に役立つアドバイスを提示する |
|MTTRアドバイザ |指定した時間にインスタンスリカバリを完了させるために、データベース内部の調整を行う |

**SQLチューニングアドバイザ　★★★**

- `SQLチューニングアドバイザ`は負荷の大きな**SELECT文**を選択し、そのSELECT文の推奨事項には次の４つがある

  + SQL文プロファイルの作成または変更

  + 新しい索引の作成

  + オプティマイザ統計のリフレッシュ

  + SQLの再構築

- 自動`SQLチューニングアドバイザ`はシステムメンテナンスタスクとして、**自動的に実行**される`アドバイザ`である。

- 自動`SQLチューニングアドバイザ`が生成するアドバイスのうち、SQLプロファイルは**自動実装**が可能である。

- `SQLアクセスアドバイザ`は、表へのアクセスを最適化するためのアドバイスを提示する。

**メモリー関連のアドバイザ　★★★**

- 自動メモリー管理、自動共有メモリー管理、手動共有メモリー管理のそれぞれでメモリー関連の各種アドバイザを起動してメモリーサイズのアドバイザを得ることができる。

- メモリー管理と使用できるアドバイザ

|メモリー管理モード |使用できるアドバイザ |
|---- |---- |
|自動メモリー管理(推奨) |メモリーアドバイザ |
|自動共有メモリー管理　＋　自動PGAメモリー管理<br>(自動メモリー管理は無効) |SGAアドバイザ<br>PGAアドバイザ |
|手動共有メモリー管理　＋　自動PGAメモリー管理<br>(自動メモリー管理、自動共有メモリー管理は無効) |場ふぁキャッシュアドバイザ<br>PGAアドバイザ |

## リンク

- [ディレクトリ](./../directory.md)

- 前章：[第九章 バックアップおよびリカバリの実行](Chapter09.md)

- 次章：[第十一章 Oracleデータベースソフトウェアの管理](Chapter11.md)
