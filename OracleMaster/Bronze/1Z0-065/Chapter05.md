# 第五章 Oracleインスタンスの管理

## 5.1 データベースサーバーのアーキテクチャ概要

**OracleインスタンスとOracleデータベース　★★★★★**

+ Oracleデータベースシステムは、`インスタンス`と`データベース`から構成される。

+ `インスタンス`とは、データベースに対するさまざまな管理を行うための**プロセス群**と、そのプロセス群が使用する**共有メモリー構造**の総称です。

+ `データベース`とは、インスタンスの管理対象である、さまざまなデータが格納されている**ファイル群**です。

+ ユーザーがデータベースを使用するには、`インスタンス`が**起動している必要がある**。

+ **インスタンス1つ**に対し**データベース1つ**です。

**インスタンス　★★★★★**

+ `インスタンス`は、共有メモリー構造である`SGA`と、`Oracleバックグラウンドプロセス`で構成される。

+ `SGA`は`データベース・バッファ・キャッシュ`、`REDOログバッファ`、`共有プール`、`ラージ・プール`、`Javaプール`、`Streamsプール`などから構成される。

+ `REDOログバッファ`**以外**の`SGA`のコンポーネントは、**サイズを動的に変更できる**。

+ `バックグラウンドプロセス`は、**ユーザー個別の処理を行うのではなく**、OSと連携してメモリー構造を管理したり、ディスクI/Oを行ってディスクにデータを書き込んだり、Oracleシステムがスムーズに働くように全体管理を行っている。

+ 主要な`バックグラウンドプロセス`には、`SMON`、`PMON`、`DBWn`、`CKPT`、`LGWR`、`ARCn`、`MMON`などがある。

+ `バックグラウンドプロセス`は、`インスタンス`の起動時に**自動的に**起動するプロセス群です。

**ユーザープロセスとサーバープロセス　★★★★**

+  `ユーザープロセス `は、ユーザーのアプリケーションのプロセスです。

+  `サーバープロセス `は、 `ユーザープロセス `から送信されたSQL文のリクエストを処理するためにデータベースサーバー側に作成されるプロセスです。

**PGA(プログラムローバル領域)　★★★★**

+ `PGA`(プログラムローバル領域：Program Global Area)は、各`サーバープロセス`や`バックグランドプロセス`が個々にデータを保存している**非共有メモリー領域**です。

+ `PGA`には次の情報が格納される。

|格納情報 |説明 |
|---- |---- |
|セッションメモリー |ログイン情報、セッションに関係するその他の情報 |
|プライベートSQL領域 |バインド変数値、問合せ実行状況の情報、および問合せ実行作業領域など |

## 5.2 インスタンスの起動・停止

**インスタンスの起動　★★★★★**

+ `インスタンス`を起動してデータベースをオープンする方法は次の通り

  + `SQL*Plus`から`STARTUP`コマンドを使用する。

  + Windows サービスプログラムを使用する。

  + `SQL Developer`を使用する。

  + `Enterprise Manager Cloud Control`を使用する。

+ データベースがオープンするまでのステップ

  1. `インスタンス`起動 (NOMOUNT状態)。その`インスタンス`用の**初期化パラメータファイル**が読み込まれます。

  2. データベースマウント (MOUNT状態)。`初期化パラメータファイル`に記述してある`CONTROL_FILES`初期化パラメータにしたがって`制御ファイル`あオープンされる。※`データファイル`も`REDOログファイル`もオープンしていない。

  3. データベースオープン (OPEN状態)。すべての`データファイル`と`REDOログファイル`がオープンされる。一般のユーザーが**接続できる**。

+ `初期化パラメータファイル`は`インスタンス`を構成するためのパラメータが記述されており、パラメータの設定にしたがって`SGA`が割り当てられ、`バックグランドプロセス`が起動します。

+ データベースがオープンするまでの各段階でオープンされるファイル

|起動までの段階 |読み込まれるファイル |
|---- |---- |
|インスタンス起動時 |`初期化パラメータファイル` |
|データベースマウント時 |`制御ファイル` |
|データベースオープン時 |すべての`データファイル`、`REDOログファイル` |

+ インスタンスの起動・停止を実行できる権限

|権限名 |説明 |
|---- |---- |
|SYSDBA |データベースを完全に制御できる |
|SYSOPER |インスタンスの起動・停止は実行できるが、ユーザーのオブジェクトのアクセス権は付与されない |

+ **SYSDBA**または**SYSOPER**権限を指定してデータベースへ接続する

```sql
CONNECT ユーザー名/パスワード AS {SYSDBA | SYSOPER}
```

+ `インスタンス`を起動・停止するには特別な管理権限(**SYSDBAまたはSYSOPER**)を付与されているユーザーで`インスタンス`に接続する必要がある。

+ `SQL*Plus`を使用した`インスタンス`の起動

  1. `SQL*Plus`を起動します。

```sh
$ sqlplus /nolog

SQL>
```

  2. `インスタンス`を起動・停止できる権限を持ったユーザーで接続します。

```sql
SQL> connect sys as sysdba
パスワードを入力してください：
接続されました。

SQL>
```

  3. `STARTUP`コマンドを実行して、`インスタンス`を起動し、データベースをオープンします。

```sql
SQL> startup
ORACLEインスタンスが起動しました。

SQL>
```

**インスタンスの停止　★★★★★**

+ インスタンスを停止してデータベースをオープンする方法は次の通り

  + `SQL*Plus`から`SHUTDOWN`コマンドを使用する。

  + Windows サービスプログラムを使用する。

  + `SQL Developer`を使用する。

  + `Enterprise Manager Cloud Control`を使用する。
 
+ `インスタンス`が停止するまでの流れ

  1. データベースのクローズ (OPEN状態 → CLOSED状態)。チェックポイントが発生し、`SGA`内のデータベースが`データファイル`および`オンラインREDOログファイル`に書き込まれ、`データファイル`と`オンラインREDOログファイル`がクローズされる。※`制御ファイル`は**オープンした**ままです。

  2. データベースのアンマウント (CLOSED状態 → DISMOUNT状態)。`制御ファイル`がクローズされ、`インスタンス`は**起動した**ままです。

  3. インスタンスの停止 (DISMOUNT状態 → SHUTDOWN状態)。`バックグランドプロセス`が終了し、`SGA`が使用している**共有メモリーの割り当てが解除され**、`インスタンス`が停止します。

+ 正常終了の場合は、`データベースのクローズ` → `データベースのアンマウント` → `インスタンスの停止`の３ステップで停止する。

+ `インスタンス`**障害時やSHUTDOWN ABORT**で緊急停止をした場合、**クローズとアンマウントが行われず**にインスタンスが**即時に停止する**。

+ `インスタンス`を停止する際は、**停止動作を決定するモード**を指定できる。停止時の**デフォルトは**`NORMAL`です。

+ 停止モードは`NORMAL`、`TRANSACTIONAL`、`IMMEDIATE`の場合は、**チェックポイントが発生し**、データベースを正常にクローズする処理が行われる。

+ 停止モード

|停止モード |説明 |
|---- |---- |
|NORMAL</br>(標準) |現在接続しているすべてのユーザーセッションが切断するのを待ってから、インスタンスを停止する。 |
|TRANSACTIONAL</br>(トランザクション) |すべてのトランザクションが完了するのを待ってからインスタンスを停止する。 |
|IMMEDIATE</br>(即時) |コミットされていないトランザクションは即時にロールバックを行ってから、インスタンスを停止する。 |
|ABORT</br>(中断) |インスタンスを即時停止する。強制終了のモード。</br>異常終了なので、次回起動時に、SMONがインスタンス・リカバリを実行する。 |

+ `SQL*Plus`を使用した`インスタンス`の停止

  1. `SQL*Plus`を起動します。

```sh
$ sqlplus /nolog

SQL>
```

  2. `インスタンス`を起動・停止できる権限を持ったユーザーで接続します。

```sql
SQL> connect sys as sysdba
パスワードを入力してください：
接続されました。

SQL>
```

  3. `SHUTDOWN`コマンドを実行して、`インスタンス`を停止し、データベースをオープンします。

```sql
SQL> shutdown immediate
データベースがクローズされました。
データベースがディスマウントされました。
ORACLEインスタンスがシャットダウンされました。

SQL>
```

**初期化パラメータファイル　★★★★**

+ `ンスタンス`が起動する際、`初期化パラメータファイル`が読み込まれる。

+ `初期化パラメータファイル`には、`初期化パラメータ`と`設定値`が格納されている。

+ `初期化パラメータ`とは、**`インスタンス`の基本動作に影響を与えるパラメータである**。

+ `初期化パラメータ`には「`動的パラメータ`」、「`静的パラメータ`」の２種類がある。

|種類 |説明 |
|---- |---- |
|`動的パラメータ` |`インスタンス`の稼働中に設定値を変更できる。 |
|`静的パラメータ` |`設定値`の変更を反映するには`インスタンス`の**再起動が必要**。 |

+ `初期化パラメータファイル`には、「`サーバーパラメータファイル(SPFILE)`」と「`テキスト初期化パラメータファイル(PFILE)`」の２種類がある。`インスタンス`の起動時にデフォルトは`SPFILE`を使用する。

  + `SPFILE`：`インスタンス`のみが**読み取りと書き込みが可能なバイナリファイル**です。テキストエディタでは編集できない。

  + `PFILE`：**テキストファイル**です。`インスタンス`によって**読み取り**はおこなえますが、**書き込みは行えません**。変更する場合は`インスタンス`を**再起動する必要がある**。
  
+ `PFILE`は、**データベース作成時**や、**障害が起きた時**などの**特殊な場合に使用します**。

+ `EM Express`と`SQL文`による初期化パラメータを確認・変更できます。

+ `SPFILE`を使用している場合、**ALTER SYSTEM文**を使用して初期化パラメータを変更する。

```SQL
ALTER SYSTEM SET パラメータ名 = 値 [SCOPE={MEMORY | SPFILE | BOTH}];
```

+ SCOPE句

|SCOPE句 |変更の適用範囲 |
|---- |---- |
|MEMORY |変更は現行`インスタンス`に対してのみ行われ、`インスタンス`が存続している間保持される |
|SPFILE |変更は`SPFILE`に対してのみ行われ、`インスタンス`を再起動することで変更が反映される |
|BOTH |現行`インスタンス`と`SPFILE`の両方が変更される</br>新し設定はすぐに有効になり、`インスタンス`が停止し、再起動された後も持続する |

+ `SPFILE`を使用している場合に、SCOPE句を省略してインスタンスを起動すると、デフォルトで「**SCOPE=BOTH**」が設定される。

+ `静的パラメータ`を変更する際は「**SCOPE=SPFILE**」を明示的に指定する必要がある。

## 5.3 メモリーコンポーネントの管理

**メモリーコンポーネントの管理方法の設定　★★★★★**

+ メモリーコンポーネントの管理方法
 
|管理方法 |管理者が指定する事項 |設定する初期化パラメータ |
|---- |---- |---- |
|自動メモリー管理(AMM) |Oracleデータベースが使用可能なメモリー</br>サイズ(SGA + インスタンスPGA) |・MEMORY_TARGET</br>・MEMORY_MAX_TARGET(静的) |
|自動共有メモリー管理(ASMM) +</br>自動PGAメモリー管理 |SGAとインスタンスPGAのサイズ |・SGA_TARGET</br>・SGA_MAX_SIZE(静的)</br>・PGA_AGGREGATE_TARGET |
|手動共有メモリー管理 +</br>自動PGAメモリー管理 |SGAの各コンポーネントのサイズとインスタンスPGAのサイズ |・DB_CACHE_SIZE</br>・SHARED_POOL_SIZE</br>・JAVA_POOL_SIZE</br>・STREAMS_POOL_SIZE</br>・LARGE_POOL_SIZE</br>・LOG_BUFFER(静的)</br>・PGA_AGGREATE_TARGET |

+ Oracleソフトウェアの基本`インスタンス`を行ってデフォルトのデータベースを作成すると`AMM`が有効になる。

+ `AMM`の初期化パラメータ

|パラメータ名 |説明 |
|---- |---- |
|MEMORY_TARGET |Oracleデータベースで使用可能なメモリーサイズ(だーゲットサイズ) |
|MEMORY_MAX_TARGET |Oracleデータベースで使用可能なメモリーの最大サイズ(静的) |

+ `AMM`の設定

```SQL
-- MEMORY_MAX_TARGET初期化パラメータの設定。※実行後再起動
ALTER SYSTEM SET MEMORY_MAX_TARGET = n[K | M | G] SCOPE = SPFILE;

-- MEMORY_TARGET初期化パラメータの設定
ALTER SYSTEM SET MEMORY_TARGET = n[K | M | G] [SCOPE = {MEMORY | SPFILE | BOTH}];

-- 自動共有メモリー管理の無効化
ALTER SYSTEM SET SGA_TARGET = 0;
ALTER SYSTEM SET PGA_AGGREGATE_TARGET = 0 [SCOPE = {MEMORY | SPFILE | BOTH}];
```

+ `AMM`の際、**SGA\_TARGET**および**PGA\_AGGREGATE\_TARGET**に値を設定すると、その値は`SGA`または`PGA`のサイズの最小値として機能する。また、`SGA`の各コンポーネントサイズを設定するパラメータ(DB_CACHE_SIZEなど)に値を設定すると、その値は各コンポーネントのサイズの**最小値**として機能する。

+ `SGA`と`PGA`のサイズを個別に制御したい場合、`自動共有メモリー管理(ASMM)`を使用する。

+ `ASMM`有効にすると、`自動PGAメモリー管理`が**黙然的なに有効**になる。

+ `ASMM`と自動PGAメモリー管理の初期化パラメータ

|パラメータ名 |説明 |
|---- |---- |
|SGE_TARGET |`SGA`のだーゲットサイズ。 |
|SGA_MAX_SIZE |`SGA`の最大サイズ(静的) |
|PGA_AGGREGATE_TARGET |`PGA`のだーゲットサイズ。動的に変更可能です。 |


+ `ASMM`の`SGE_TARGET`が指定されている場合、`SGA`内の次のメモリーコンポーネントのサイズは自動的に設定される。

  + データベース・バッファ・キャッシュ(DB_CACHE_SIZE)

  + 共有プール(SHARED_POOL_SIZE)

  + Javaプール(JAVA_POOL_SIZE)

  + Streamsプール(STREAMS_POOL_SIZE)

  + ラージ・プール(LARGE_POOL_SIZE)

+ `ASMM`の設定

```SQL
-- 自動メモリー管理の無効化
ALTER SYSTEM SET MEMORY_TARGET = 0 [SCOPE = {MEMORY | SPFILE | BOTH}];

-- SGA_MAX_SIZEの設定　※実行後再起動
ALTER SYSTEM SET SGA_MAX_SIZE = n[K | M | G] SCOPE = SPFILE;

-- SGA_TARGETの設定
ALTER SYSTEM SET SGA_TARGET = n[K | M | G] [SCOPE = {MEMORY | SPFILE | BOTH}];

-- PGA_AGGREGATE_TARGETTの設定
ALTER SYSTEM SET PGA_AGGREGATE_TARGET = n[K | M | G];

-- SGA内のメモリーコンポーネントのサイズを自動化
ALTER SYSTEM SET SHARED_POOL_SIZE = 0;
ALTER SYSTEM SET LARGE_POOL_SIZE = 0;
ALTER SYSTEM SET JAVA_POOL_SIZE = 0;
ALTER SYSTEM SET DB_CACHE_SIZE = 0;
ALTER SYSTEM SET STREAMS_POOL_SIZE = 0;
```
+ `ASMM`の際、`SGA`の各コンポーネントサイズを設定するパラメータ(DB_CACHE_SIZEなど)に値を設定すると、その値は各コンポーネントサイズの**最小値**として機能する。

+ `AMM`と`ASMM`を無効にすると`手動共有メモリー管理`になり、また`自動PGAメモリー管理`が**黙然的なに有効**になる。

+ 手動共有メモリー管理の設定

```SQL
-- 自動メモリー管理の無効化
ALTER SYSTEM SET MEMORY_TARGET = 0 [SCOPE = {MEMORY | SPFILE | BOTH}];

-- 自動共有メモリー管理の無効化
ALTER SYSTEM SET SGA_TARGET = 0 [SCOPE = {MEMORY | SPFILE | BOTH}];

-- SGA内のメモリーコンポーネントのサイズを設定
ALTER SYSTEM SET SHARED_POOL_SIZE = n[K | M | G];
ALTER SYSTEM SET LARGE_POOL_SIZE = n[K | M | G];
ALTER SYSTEM SET JAVA_POOL_SIZE = n[K | M | G];
ALTER SYSTEM SET DB_CACHE_SIZE = n[K | M | G];
ALTER SYSTEM SET STREAMS_POOL_SIZE = n[K | M | G];
ALTER SYSTEM SET PGA_AGGREGATE_TARGET = n[K | M | G];
```

## リンク

- [ディレクトリ](./../directory.md)

- 前章：[第四章 Oracleネットワーク環境の構成](Chapter04.md)

- 次章：[第六章 データベース記憶域構造の管理](Chapter06.md)
