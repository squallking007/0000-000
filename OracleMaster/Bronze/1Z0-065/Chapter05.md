# 第五章 Oracleインスタンスの管理

## 5.1 データベースサーバーのアーキテクチャ概要

**OracleインスタンスとOracleデータベース　★★★★★**

+ Oracleデータベースシステムは、```Oracleインスタンス```と```Oracleデータベース```から構成される。

+ **インスタンス**とは、データベースに対するさまざまな管理を行うためのプロセス群と、そのプロセス群が使用する共有メモリー構造の総称です。

+ **データベース**とは、インスタンスの管理対象である、さまざまなデータが格納されているファイル群です。

+ ユーザーがデータベースを使用するには、**インスタンスが起動している必要がある**。

+ **インスタンス1つ**に対し**データベース1つ**です。

**インスタンス　★★★★★**

+ インスタンスは、共有メモリー構造である```SGA```と、```Oracleバックグラウンドプロセス```で構成される。

+ SGAは```データベース・バッファ・キャッシュ```、```REDOログバッファ```、```共有プール```、```ラージ・プール```、```Javaプール```、```Streamsプール```などから構成される。

+ REDOログバッファ以外のSGAのコンポーネントは、**サイズを動的に変更できる**。

+ バックグラウンドプロセスは、**ユーザー個別の処理を行うのではなく**、OSと連携してメモリー構造を管理したり、ディスクI/Oを行ってディスクにデータを書き込んだり、Oracleシステムがスムーズに働くように全体管理を行っている。

+ 主要なバックグラウンドプロセスには、```SMON```、```PMON```、```DBWn```、```CKPT```、```LGWR```、```ARCn```、```MMON```などがある。

+ **Oracleバックグラウンドプロセス**は、インスタンスの起動時に**自動的に**起動するプロセス群です。

**ユーザープロセスとサーバープロセス　★★★★**

+ **ユーザープロセス**は、ユーザーのアプリケーションのプロセスです。

+ **サーバープロセス**は、ユーザープロセスから送信されたSQL文のリクエストを処理するためにデータベースサーバー側に作成されるプロセスです。

**PGA(プログラムローバル領域)　★★★★**

+ **PGA(プログラムローバル領域：Program Global Area)**は、各サーバープロセスやバックグランドプロセスが個々にデータを保存している**非共有メモリー領域**です。

+ PGAには次の情報が格納される。

  + **セッションメモリー**(ログイン情報、セッションに関係するその他の情報)
  
  + **プライベートSQL領域**(バインド変数値、問合せ実行状況の情報、および問合せ実行作業領域など)

## 5.2 インスタンスの起動・停止

**インスタンスの起動　★★★★★**

+ インスタンスを起動してデータベースをオープンする方法は次の通り

 + SQL*Plusから```STARTUP```コマンドを使用する。
 
 + Windows サービスプログラムを使用する。
 
 + SQL Developerを使用する。
 
 + Enterprise Manager Cloud Controlを使用する。

+ データベースがオープンするまでのステップ

 1. インスタンス起動 (NOMOUNT状態)
 
 2. データベースマウント (MOUNT状態)
 
 3. データベースオープン (OPEN状態)

+ データベースがオープンするまでの各段階でオープンされるファイル

|起動までの段階 |読み込まれるファイル |
|---- |---- |
|インスタンス起動時 |初期化パラメータファイル |
|データベースマウント時 |制御ファイル |
|データベースオープン時 |すべてのデータファイル、REDOログファイル |

+ インスタンスの起動・停止を実行できる権限

|権限名 |説明 |
|---- |---- |
|SYSDBA |データベースを完全に制御できる |
|SYSOPER |インスタンスの起動・停止は実行できるが、ユーザーのオブジェクトのアクセス権は付与されない |

+ SYSDBAまたはSYSOPER権限を指定してデータベースへ接続する

```sql
CONNECT ユーザー名/パスワード AS {SYSDBA | SYSOPER}
```

+ インスタンスを起動・停止するには特別な管理権限(**SYSDBAまたはSYSOPER**)を付与されているユーザーでインスタンスに接続する必要がある。

**インスタンスの停止　★★★★★**

+ インスタンスを停止してデータベースをオープンする方法は次の通り

 + SQL*Plusから```SHUTDOWN```コマンドを使用する。
 
 + Windows サービスプログラムを使用する。
 
 + SQL Developerを使用する。
 
 + Enterprise Manager Cloud Controlを使用する。
 
+ インスタンスが停止するまでの流れ

 1. データベースのクローズ (OPEN状態 → CLOSED状態)
 
 2. データベースのアンマウント (CLOSED状態 → DISMOUNT状態)
 
 3. インスタンスの停止 (DISMOUNT状態 → SHUTDOWN状態)
 
+ 正常終了の場合は、```データベースのクローズ``` → ```データベースのアンマウント``` → ```インスタンスの停止```の３ステップで停止する。

+ **インスタンス障害時やSHUTDOWN ABORT**で緊急停止をした場合、**クローズとアンマウントが行われず**にインスタンスが**即時に停止する**。

+ 停止モード

|停止モード |説明 |
|---- |---- |
|NORMAL</br>(標準) |現在接続しているすべてのユーザーセッションが切断するのを待ってから、インスタンスを停止する。 |
|TRANSACTIONAL</br>(トランザクション) |すべてのトランザクションが完了するのを待ってからインスタンスを停止する。 |
|IMMEDIATE</br>(即時) |コミットされていないトランザクションは即時にロールバックを行ってから、インスタンスを停止する。 |
|ABORT</br>(中断) |インスタンスを即時停止する。強制終了のモード。</br>異常終了なので、次回起動時に、SMONがインスタンス・リカバリを実行する。 |

**初期化パラメータファイル　★★★★**

+ インスタンスが起動する際、**初期化パラメータファイル**が読み込まれる。

+ 初期化パラメータファイルには、```初期化パラメータ```と```設定値```が格納されている。

+ 初期化パラメータとは、インスタンスの基本動作に影響を与えるパラメータである。

+ 初期化パラメータには「```動的パラメータ```」、「```静的パラメータ```」の２種類がある。

 + 動的パラメータ：インスタンスの稼働中ｎ設定値を変更できる。
 
 + 静的パラメータ：設定値の変更を反映するにはインスタンスの再起動が必要。

+ 初期化パラメータファイルには、「```サーバーパラメータファイル(SPFILE)```」と「```テキスト初期化パラメータファイル(PFILE)```」の２種類がある。

 + SPFILE：インスタンスのみが読み取りと書き込みが可能な**バイナリファイル**です。
 
 + PFILE：**テキストファイル**です。インスタンスによって読み取りはおこなえますが、**書き込みは行えません**。
 
+ SPFILEを使用している場合、**ALTER SYSTEM文**を使用して初期化パラメータを変更する。

```SQL
ALTER SYSTEM SET パラメータ名 = 値 [SCOPE={MEMORY | SPFILE | BOTH}];
```

+ SCOPE句

|SCOPE句 |変更の適用範囲 |
|---- |---- |
|MEMORY |変更は現行インスタンスに対してのみ行われ、インスタンスが存続している間保持される |
|SPFILE |変更はサーバーパラメータファイルに対してのみ行われ、インスタンスを再起動することで変更が反映される |
|BOTH |現行インスタンスとサーバーパラメータファイルの両方が変更される</br>新し設定はすぐに有効になり、インスタンスが停止し、再起動された後も持続する |

+ サーバーパラメータファイルを使用している場合に、SCOPE句を省略してインスタンスを起動すると、デフォルトで「**SCOPE=BOTH**」が設定される。

+ 静的パラメータを変更する際は「**SCOPE=SPFILE**」を明示的に指定する必要がある。

## 5.3 メモリーコンポーネントの管理

**メモリーコンポーネントの管理方法の設定　★★★★★**

+ メモリーコンポーネントの管理方法
 
|管理方法 |管理者が指定する事項 |設定する初期化パラメータ |
|---- |---- |---- |
|自動メモリー管理(AMM) |Oracleデータベースが使用可能なメモリー</br>サイズ(SGA + インスタンスPGA) |・MEMORY_TARGET</br>・MEMORY_MAX_TARGET(静的) |
|自動共有メモリー管理(ASMM) +</br>自動PGAメモリー管理 |SGAとインスタンスPGAのサイズ |・SGA_TARGET</br>・SGA_MAX_SIZE(静的)</br>・PGA_AGGREGATE_TARGET |
|手動共有メモリー管理 +</br>自動PGAメモリー管理 |SGAの各コンポーネントのサイズとインスタンスPGAのサイズ |・DB_CACHE_SIZE</br>・SHARED_POOL_SIZE</br>・JAVA_POOL_SIZE</br>・STREAMS_POOL_SIZE</br>・LARGE_POOL_SIZE</br>・LOG_BUFFER(静的)</br>・PGA_AGGREATE_TARGET |
 
