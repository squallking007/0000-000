# 第六章 データベース記憶域構造の管理

## 6.1 データベース記憶域構造の管理

**データベース記憶域構造の概要　★★★★**

- データベースの物理構造として、以下の３種類のファイルを覚えてください。

|ファイル名 |説明 |
|---- |---- |
|**制御ファイル** |**物理構造に関する情報**が格納される(データベースを構成するファイル群のパス名など) |
|**REDOログファイル**|データに対して行われた**変更情報**が格納される|
|**データファイル** |すべての表や索引の**データ**が格納される|

- データベースの論理構造は、データベースによって作成されます。主な構造は「`表領域`」です。

- `表領域`は、表や索引などのデータベースのオブジェクトを格納する入れ物と考えることができます。

- 各表領域に対して**１つ以上のデータファイル**が作成されます。

- データベースでは、`表`(データ)を、**論理的に**は`表領域`に格納し、**物理的に**は`表領域`に関連付けられたデータファイルに格納する。

- データベースの記憶域構造は、`EM Express`の「記憶域」メニューで確認できる。

**制御ファイル　★★★★★**

- `制御ファイル`は、データベースの物理構造の情報が記録された**バイナリファイル**です。**データベースのマウント時**に読み込まれます。

- `制御ファイル`のファイル名は「`CONTORL_FILES`」**初期化パラメータ**で指定する。`インスタンス`の起動時に読み込まれって、`制御ファイル`のパス名が確認され、すべての`データファイル`と`REDOログファイル`のパス名が確認される。

- `制御ファイル`は**データベースによって自動的に更新される**。

- `制御ファイル`にアクセスできなくなると、`インスタンス`が**停止します**。`制御ファイル`の損失によるデータベース障害に対応するために、通常は`制御ファイル`は多重化しておく。

- `EM Express`を使用して、制御ファイルの情報を確認できる。「記憶域」メニューから「制御ファイル」を選択し、`制御ファイル`のパス名と`ステータス情報`が表示される。

**REDOログファイル　★★★**

- `REDOログファイル`は、ユーザーがSQL文を使用して行った**トランザクションの内容**やデータベースが内部的に行った**データベースへの変更**が記録されるファイルです。データベースの`リカバリ`の機能を担保する。

- `トランザクション`の変更情報である`REDOレコード`は、一時的に`SGA`内の`RADOログバッファ`に書き込まれます。`RADOログバッファ`の`RADOレコード`は、`トランザクション`のCOMMIT時に、`LGWR`(ログライター)プロセスによって`REDOログファイル`に書き込まれる。

- `REDOログファイル`は必ず**２つ以上のREDOロググループ**で構成され、`LGWR`は各グループに対して、**循環方式**で書き込みを行う。

- **各REDOロググループには１つ以上のREDOログファイル**が含まれる。１つのグループ内に複数のファイルが構成されている場合、それらのファイルには**同一の内容が書き込まれる**。

- `LGWR`の書き込み対象の`REDOログファイル`を含むグループのことを「`カレントのREDOロググループ`」(現行のREDOロググループ)と言います。

- `REDOログファイル`の書き込み先が切り替わることを「`ログスイッチ`」と言います。`ログスイッチ`は**ALTER SYSTEM SWITCH LOGFILE文**によって手動で実行することもできます。

- `アーカイブログファイル`は、`REDOログファイル`が上書きされる前に**コピーされたファイルである**。`ARCn`プロセスによって`アーカイブ`される`REDOログファイル`のコピーです。

- `ARCn`プロセスは、`ログスイッチ`によって書き込み先が切り替わったタイミングで、`アーカイブログファイル`を作成する。

- グループ内のそれぞれの`REDOログファイル`を「**メンバー**」といい、グループ内に**２つ以上**のメンバーがある状態が**多重化されている状態**である。

- 障害に備えるために、２つ以上の`REDOログファイル`の同一のコピーを別々のディスクに保持できるように多重化することが推奨されている。

- `EM Express`による`REDOログファイル`を多重化できます。

  1. `EM Express`の「記憶域」メニューから「REDOログ・グループ」をクリックする。

  2. 「REDOログ・グループ」ページでメンバーを追加したいグループを選択して、「アクション」メニューから「メンバーの追加」をクリックする。

  3. 「メンバーの追加」ウィンドゥでファイル名フィールドにファイル名を指定して、「OK」ボタンをクリックする。

  4. 確認画面で「OK」ボタンをクリックする。

  5. １つの`REDOロググループ`にメンバーが追加されました。

**表領域とデータファイル　★★★★★**

- データベースのオブジェクトである`表`や`索引`は「`セグメント`」という論理構造として、「`表領域`」という論理構造に格納されます。

- `表領域`は`表`や`索引`をまとめるは入れ物と考えることができる。各`表領域`に対して**１つ以上のデータファイル**が作成され、`表領域`に格納された`セグメント`は、物理的に`表領域`に対応する１つ以上の`データファイル`に格納されます。

- データベースには**複数の表領域**があり、これによってデータを論理的に分割することができる。

- `UNDOセグメント`や`一時セグメント`といった、Oracleデータベースシステムが内部的に使用する`セグメント`は、専用の`表領域`に格納する。

- Oracleデータベースの論理構造には「`表領域`」「`セグメント`」「`エクステント`」「`データブロック`」があります。

- `記憶域`の論理構造に関する用語

|用語 |説明 |
|---- |---- |
|**表領域** |データベース内のオブジェクトをグループ化して格納するための領域。<br> `表領域`に対して**１つ以上のデータファイル**が作成される。また、`表領域`には複数の`セグメント`を格納できる。 |
|**セグメント** |`表`や`索引`、`UNDOセグメント`などのデータベースオブジェクトによって使用される領域。<br>１つのオブジェクトが１つの`セグメントと`なる。<br> `セグメント`には、データの種類によっていろいろなタイプがある。<br>１つの`セグメント`は、同じ`表領域`内であれば複数の`データファイル`にまたがることが可能。<br>`セグメント`の領域は**エクステント単位**で割り当てられ、割り当てられた`エクステント`が満杯になったら、その`セグメント`に対して新しい`エクスタント`が割り当てられる。 |
|**エクスタント** |１回の割り当てで取得される**特定数の連続したデータブロック**。<br>`エクスタント`のサイズは**表領域の作成時**に指定できる。<br>１つの`エクステント`は**データファイルをまたぐことはできない**。 |
|**データブロック** |**I/Oの最小単位。**<br>`データブロック`には**データ**が格納される。<br>オブジェクトが表であれば、１つの`データブロック`に**複数の行**を格納できる。<br>`データブロック`のサイズは、**データベースの作成時**に指定できるが、事前構成済のデータベースを選択した場合、`データブロック`サイズは**8K**で固定され、変更できない。 |

- 事前構成済データベースの`表領域`

|表領域名 |説明 |
|---- |---- |
|SYSTEM |データベース作成時に自動的に作成される`表領域`。<br>**データベースの管理情報**を格納する。**データディクショナリ**はこの表領域に格納される。`SYSTEM表領域`内のオブジェクトは**SYSスキーマ**に存在するため、SYSユーザーまたは必要な権限を持つ管理者ユーザーしかアクセスできない。 |
|SYSAUX |`SYSTEM表領域`の補助`表領域`。<br>データベース作成時的に**自動的に作成**される。 |
|TEMP |データベースには、ユーザーに割り当てられる`一時表領域`を作成しておく必要がある。<br>`一時表用域`には、ソート処理のデータといった、セッション中にのみ存在する、SQL文の処理中に生成された一時的なデータが格納される。 |
|UNDOTBS1 |**UNDOデータ**の保存に使用する`表領域`。<br>データベースの作成時に作成される。`UNDO表領域`がすべてのデータベースに必要。 |
|USERS |ユーザーが作成するオブジェクトを格納するための`表領域`<br>事前構成済データベースでは、`USERS表領域`がすべての新しユーザーのデフォルト`表領域`に指定される。 |
|EXAMPLE |DBCAの中で「サンプルスキーマを作成する」チェックボックスにチェックを付けると作成される表領域。<br>さまざまなサンプルテーブルが格納される。 |

- `SYSTEM表領域`と`SYSAUX表領域`には、データベースの管理情報が格納される。

- `データディクショナリ`は`SYSTEM表領域`に格納される。

- `SYSAUX表領域`は`SYSTEM表領域`の補助`表領域`として使用される。

## 6.2 表領域の管理

**表領域の新規作成　★★★★**

- `EM Express`を使用して、表領域を新規作成できる。

- SQL文を使用して表領域を作成する。には、`CREATE TABLESPACE`文を使用します。文内で**データファイルのサイズ**と**ファイルパス**を指定します。

- SQL文を使用して表領域の作成

```SQL
CREATE TABLESPACE 表領域名 DATAFILE 'データファイル名' SIZE サイズ
    [EXTENT MANAGEMENT LOCAL {AUTOALLOCATE | UNIFORM SIZE サイズ}]
    [SEGMENT SPACE MANAGEMENT {AUTO | MANUAL}];
```

- `表領域`を作成する際は、以下のオプションを指定できます。
  + `EXTENT MANAGEMENT LOCAL`  ローカル管理表領域です。
    * **AUTOALLOCATE** データベースが自動的に`エクステント`の割り当てを管理する。最小`エクステント`サイズは**64KB**。デフォルト値。
    * **UNIFORM SIZE サイズ** `エクステント`が<サイズ>に指定したサイズで均一に管理される。サイズを指定しない場合の**デフォルトは1MB**。
  + `SEGMENT SPACE MANAGEMENT`  `せグメント領域`の管理方法です。
    * **AUTO 自動セグメント領域管理**では、`セグメント`内の空き領域を管理するために、「ビットマップ」を使用します。
    * **MANUAL 手動セグメント領域管理**では、`セグメント`内の空き領域を管理するために、「空きリスト」と呼ばれるリンクされたリストを私用します。

- **自動セグメント領域管理**のほうがより効率的であるため、**通常はこちらを選択します**。

- `OMF`(Oracle Managed Files)を使用して`表領域`を作成する。OSファイルはデータベースによって自動的に作成され、管理される。

- `OMF`を使用する場合は**DB_CREATE_FILE_DEST初期化パラメータ**でファイルの作成場所を定義します。

- ファイルの作成場所の指定

```SQL
-- ファイルの作成場所の指定
ALTER SYSTEM SET DB_CREATE_FILE_DEST = 'ディレクトリ名';

-- 表領域の作成
CREATE TABLESPACE 表領域名;
```

- **表領域を新規作成すると、その表領域に対応するデータファイルが指定したサイズで作成される。**

**表領域の拡張　★★★★**

- `表領域`のサイズを増やす場合は、次のように`データファイル`を追加するか、または`表領域`の`データファイル`のサイズを増やします。

  + 既存の`表領域`へ`データファイル`を追加する。

  + 既存の`データファイル`のサイズを手動拡張する。

  + 既存の`データファイル`の自動拡張を設定する。

- 既存の`表領域`へ`データファイル`を追加するには`ALTER TABLESPACE文`を使用します。

``` SQL
ALTER TABLESPACE 表領域名 ADD DATAFILE `データファイル名` SIZE サイズ;
```

- 既存の`データファイル`のサイズを手動で拡張するには、`ALTER DATABASE文`を使用します。

```SQL
ALTER DATABASE DATAFILE 'データファイル名' RESIZE サイズ;
```

- 既存の`データファイル`に自動拡張の設定を行うと、より多くの領域が必要になった場合に自動的に`データファイル`のサイズが拡張されます。`エクステント`がさらに必要になった場合は、**NEXT句**で指定した増分サイズの領域を、**MAXSIZE句**で指定した最大サイズになるまで自動的に割り当てることができます。なお、`データファイル`に割り当てられるディスク領域を制限しない場合は、**UNLIMITED**を指定します。

```SQL
ALTER DATABASE DATAFILE 'データファイル名'
    AUTOEXTEND ON
    NEXT サイズ
    MAXSIZE {サイズ | UNLIMITED};
```

- `表領域`の拡張以外の変更操作には、次のような操作があります。

  + `表領域`使用率のアラートのしきい値を変更する。

  + `表領域`のステータス(状態)をオフラインに変更する。

**表領域の削除　★★★★**

- `表領域`を削除すると、`表領域`に格納されているオブジェクトや、データディクショナリに格納されているオブジェクトの定義も削除されます。

  + `EM Express`を使用した場合はデフォルトで削除される設定になっている。

  + SQL文を使用した場合は**デフォルトでは削除されません**。

- SQL文を使用して`表領域`を削除するには、`DROP TABLESPACE文`を使用します。空でない`表領域`を内部の`セグメント`も含めて削除する場合は「`INCLUDING CONTENTS`」を指定します。

- `表領域`の削除文

```SQL
DROP TABLESPACE 表領域名 INCLUDING CONTENTS;
```

- `表領域`の削除文(データファイルも削除)

```SQL
DROP TABLESPACE 表領域名 INCLUDING CONTENTS AND DATAFILES;
```

- `表領域`のオフライン化

```SQL
ALTER TABLESPACE 表領域名 OFFLINE;
```

- **表領域を削除すると表領域に格納されているオブジェクトも削除される。**

- **オブジェクトのデータだけでなく、データディクショナリに格納されているオブジェクトの定義も削除される。**

- **EM Expressを使用して表領域を削除すると、デフォルトで、表領域に対応付けられているデータファイルも削除される。**

**オンラインでのセグメントの縮小　★★★★**

- `セグメントアドバイザ`を使用すると、断片化されたデータを統合できる`セグメント`の分析と`セグメント`の縮小操作を行える。

- `セグメント`内の空き領域を再利用するためには、次のステップを踏む。

  1. `セグメントアドバイザ`で`セグメント`の縮小操作を実行できるかどうか、断片化されたデータを統合できるかどうかを分析する。
  
  2. 縮小操作を実行して、`セグメント`を圧縮する。
  
  3. 縮小操作を実行してできた空き領域は、他の`セグメント`で使用できるように表用域に戻すか、同一`セグメント`の今後のデータの挿入に備えてそのまま残すことができる。

## 6.3 データの整合性保持のための構造管理

**UNDOデータとは　★★★★★**

- `UNDOデータ`とは、`ドランザクション`によってデータの変更が行われる前に、データベースによって取得される**データのコピー**です。

- `UNDOデータ`は、次の目的のために使用されます。

  + ロールバック操作

  + 読取り一貫性

  + フラッシュバック機能

  + データベースのリカバリ

- **ロールバック操作**は、データベースに対して行われた**「コミットされていない変更」を元に戻す操作**です。

- **読取り一貫性**は、ユーザーがデータを問合せ中にそのデータに対して別の変更が行われても、問合せているユーザーは一貫したデータを見ることができるという機能です。

- **フラッシュバック機能**とは、コミット済みのデータを過去のある時点のデータの表示やリカバリを行う機能です。

- **データベースのリカバリ**は障害が起こった後の**リカバリ操作**です。

**UNDO保存期間　★★★★★**

- `トランザクション`のコミット後も、さらにUNDOデータを保持する時間を「UNDO保存時間」という。

- `UNDOデータ`を適切に保持しておくと、フラッシュバック機能や読取り一貫性で使用できる。

- 自動UNDO管理が行われているデータベースでは、UNDO保存期間は自動的にチューニングされる。

- 自動拡張する`UNDO表領域`を使用している場合、UNDO保存期間の下限値(秒)を**UNDO_RETENTION初期あパラメータ**で指定できる。

- 「UNDO保存期間の保証」オプションを有効にすると、指定したUNDOの最小保存期間が保証される。`UNDO表領域`の領域不足によって`トランサミン`が失敗する場合でも、期限切れでない`UNDOデータ`は上書きされない。

**UNDOデータの管理　★★★★★**

- Oracle Database 12cでは「`自動UNDO管理`」がデフォルトのモードです。

- `自動UNDO管理`では、`UNDOデータ`は**UNDOセグメント**に格納され、`UNDOセグメント`は**UNDO表領域**という特別な`表領域`に格納される。

- `UNDOセグメント`は自動的に作成され、自動的に`エクステント`が割り当てられる。

- `UNDOセグメント`の**所有者はSYSユーザー**です。

- １つの`インスタンス`に対して、１つの`UNDO表領域`が**必要**です。

- `UNDO表領域`が自動拡張可能な場合、UNDO保存期間は、最も時間のかかる問合せよりもわずかに長くなるようにチューニングされる。

- `UNDO表領域`が小さい場合、次のエラーが発生する可能性がある。

  + 新し`トランザクション`に対応する`UNDOデータ`を格納するための領域が足リないことによろDML文の失敗。

  + `UNDOデータ`の不足によって読取り一貫性が維持できないことによる、「スナップショットが古すぎます」のエラーの発生。

- `UNDO表領域`が小さい場合、上記のエラーが発生するだけでなく、フラッシュバック機能にも影響するため、適切なサイズにする。

**UNDOアドバイザ　★★★★★**

- `UNDOアドバイザ`を使用すると、将来の長時間実行問合せやフラッシュバック操作に対応できる`UNDO表領域`の最小サイズを判断できる。

## リンク

- [ディレクトリ](./../directory.md)

- 前章：[第五章 Oracleインスタンスの管理](Chapter05.md)

- 次章：[第七章 ユーザーおよびセキュリティの管理](Chapter07.md)
