# 第六章 データベース記憶域構造の管理

## 6.1 データベース記憶域構造の管理

**データベース記憶域構造の概要　★★★★**

- データベースの物理構造として、以下の３種類のファイルを覚えてください。

|ファイル名 |説明 |
|---- |---- |
|**制御ファイル** |**物理構造に関する情報**が格納される(データベースを構成するファイル群のパス名など) |
|**REDOログファイル**|データに対して行われた**変更情報**が格納される|
|**データファイル** |すべての表や索引の**データ**が格納される|

- データベースの論理構造は、データベースによって作成されます。主な構造は「```表領域```」です。

-  ```表領域```は、表や索引などのデータベースのオブジェクトを格納する入れ物と考えることができます。

-  各表領域に対して**１つ以上のデータファイル**が作成されます。

-  データベースでは、表(データ)を、論理的には表領域に格納し、物理的には表領域に関連付けられたデータファイルに格納する。

-  データベースの記憶域構造は、EM Expressの「```記憶域```」メニューで確認できる。

**制御ファイル　★★★★★**

-  ```制御ファイル```は、データベースの物理構造の情報が記録された**バイナリファイル**です。**データベースのマウント時**に読み込まれます。

-  ```制御ファイルのファイル名```は「CONTORL_FILES」初期化パラメータで指定する。インスタンスの起動時に読み込まれって、制御ファイルのパス名が確認され、データベースのマウント時に制御ファイルが読み込まれて、すべてのデータファイルとREDOログファイルのパス名が確認される。

-  制御ファイルは**データベースによって自動的に更新される**。

-  制御ファイルの損失によるデータベース障害に対応するために、通常は制御ファイルは多重化しておく。

-  ```EM Express```を使用して、制御ファイルの情報を確認できる。

**REDOログファイル　★★★**

-  ```REDOログファイル```は、ユーザーがSQL文を使用して行った**トランザクションの内容**やデータベースが内部的に行った**データベースへの変更**が記録されるファイルです。

-  ```REDOログファイル```は、データベースのリカバリの機能を担保する。

-  トランザクションの変更情報である```REDOレコード```は、一時的にSGA内の```RADOログバッファ```に書き込まれます。RADOログバッファのRADOレコードは、トランザクションのCOMMIT時に、```LGWR(ログライター)```プロセスによって```REDOログファイル```に書き込まれる。

-  ```REDOログファイル```は必ず**２つ以上のREDOロググループ**で構成され、```LGWR```は各グループに対して、**循環方式**で書き込みを行う。

-  **各REDOロググループには１つ以上のREDOログファイル**が含まれる。１つのグループ内に複数のファイルが構成されている場合、それらのファイルには**同一の内容が書き込まれる**。

-  各グループはログ**順序番号**で識別される。

-  ```LGWR```の書き込み対象のREDOログファイルを含むグループのことを「```カレントのREDOロググループ```」と言います。

-  ```REDOログファイル```の書き込み先が切り替わることを「```ログスイッチ```」と言います。ログスイッチはALTER SYSTEM SWITCH LOGFILE文によって手動で実行することもできます。

-  ```アーカイブログファイル```は、REDOログファイルが上書きされる前にコピーされたファイルである。

-  アーカイブログファイルは、**ARCn**が作成する。

-  グループ内のそれぞれのREDOログファイルを「**メンバー**」といい、グループないに２つ以上のメンバーがある状態が多重化されている状態である。

-  障害に備えるために、２つ以上のREDOログファイルの同一のコピーを別々のディスクに保持できるように多重化することが推奨されている。

**表領域とデータファイル　★★★★★**

-  データベースのオブジェクトである表や索引は「```セグメント```」という論理構造として、「```表領域```」という論理構造に格納されます。

-  ```表領域```は表や索引をまとめるは入れ物と考えることができる。各表領域に対して**１つ以上のデータファイル**が作成され、表領域に格納されたセグメントは、物理的に表領域に対応する１つ以上のデータファイルに格納されます。

-  データベースには**複数の表領域**があり、これによってデータを論理的に分割することができる。

-  UNDOセグメントや一時セグメントといった、Oracleデータベースシステムが内部的に使用するセグメントは、専用の表領域に格納する。

-  Oracleデータベースの論理構造には「```表領域```」「```セグメント```」「```エクステント```」「```データブロック```」があります。

-  記憶域の論理構造に関する用語

|用語 |説明 |
|---- |---- |
|**表領域** |データベース内のオブジェクトをグループ化して格納するための領域。<br> 表領域に対して**１つ以上のデータファイル**が作成される。<br>また、表領域には複数のセグメントを格納できる。 |
|**セグメント** |表や索引、UNDOセグメントなどのデータベースオブジェクトによって使用される領域。<br>１つのオブジェクトが１つのセグメントとなる。<br> セグメントには、データの種類によっていろいろなタイプがある。<br>１つのセグメントは、同じ表領域内であれば複数のデータファイルにまたがることが可能。<br>セグメントの領域は**エクステント単位**で割り当てられ、割り当てられたエクステントが満杯になったら、そのセグメントにたいしてあたらしいエクスタントが割り当てられる。 |
|**エクスタント** |１回の割り当てで取得される**特定数の連続したデータブロック**。<br>エクスタントのサイズは**表領域の作成時**に指定できる。<br>１つのエクステントは**データファイルをまたぐことはできない**。 |
|**データブロック** |**I/Oの最小単位。**<br>データブロックには**データ**が格納される。<br>オブジェクトが表であれば、１つのデータブロックに**複数の行**を格納できる。<br>データブロックのサイズは、**データベースの作成時**に指定できるが、事前構成済のデータベースを選択した場合、データブロックサイズは**8K**で固定され、変更できない。 |

-  事前構成済データベースの表領域

|表領域名 |説明 |
|---- |---- |
|SYSTEM |データベース作成時に自動敵に作成される表領域。<br>Oracleデータベースシステムがデータベースの管理情報を格納する。データディクショナリはこの表領域に格納される。SYSTEM表領域内のオブジェクトはSYSスキーマに存在するため、SYSユーザーまたは必要な権限を持つ管理者ユーザーしかアクセスできない。 |
|SYSAUX |SYSTEM表領域の補助表領域。<br>データベース作成時的に自動的に作成される。 |
|TEMP |データベースには、ユーザーに割り当てられる一時表領域を作成しておく必要がある。<br>一時表用域には、ソート処理のデータといった、セッション中にのみ存在する、SQL文の処理中に生成された一時的なデータが格納される。　 |
|UNDOTBS1 |OracleデータベースシステムがUNDOデータの保存に使用する表領域。<br>データベースの作成時に作成される。UNDO表領域がすべてのデータベースに必要。 |
|USERS |ユーザーが作成するオブジェクトを格納するための表領域<br>事前構成済データベースでは、USERS表領域がすべての新しユーザーのデフォルト表領域に指定される。 |
|EXAMPLE |DBCAの中で「サンプルスキーマを作成する」チェックボックスにチェックを付けると作成される表領域。<br>さまざまなサンプルテーブルが格納される。 |

## 6.2 表領域の管理

**表領域の新規作成　★★★★**

-  ```EM Express```を使用して、表領域を新規作成できる。

-  SQL文を使用して表領域を作成する。には、```CREATE TABLESPACE```文を使用します。文内で**データファイルのサイズ**と**ファイルパス**を指定します。

-  SQL文を使用して表領域の作成

```SQL
CREATE TABLESPACE 表領域名 DATAFILE 'データファイル名'　SIZE サイズ
    [EXTENT MANAGEMENT LOCAL {AUTOALLOCATE | UNIFORM SIZE サイズ}]
    [SEGMENT SPACE MANAGEMENT {AUTO | MANUAL}];
```

- 表領域を作成する際は、以下のオプションを指定できます。
  + ```EXTENT MANAGEMENT LOCAL``` ローカル管理表領域です。
    - **AUTOALLOCATE** データベースが自動的にエクステントの割り当てを管理する。最小エエクステントサイズは64KB。デフォルト値。
    * **UNIFORM SIZE サイズ** エクステ  ントが<サイズ>に指定したサイズで均一に管理される。サイズを指定しない場合のデフォルトは1MB。
  + ```SEGMENT SPACE MANAGEMENT```   グメント領域の管理方法です。
    - **自動セグメント領域管理**では、セグメント内の空き領域を管理するために、「ビットマップ」を使用します。
    * **手動セグメント領域管理**では、セグメント内の空き領域を管理するために、「空きリスト」と呼ばれるリンクされたリストを私用します。

- **自動セグメント領域管理**のほうがより効率的であるため、**通常はこちらを選択します**。

-  ```OMF(Oracle Managed Files)```を使用して表領域を作成する。OSファイルはデータベースによって自動的に作成され、管理される。

-  ```OMF```を使用する場合は**DB_CREATE_FILE_DEST初期化パラメータ**でファイルの作成場所を定義します。

-  ファイルの作成場所の指定

```SQL
ALTER SYSTEM SET DB_CREATE_FILE_DEST = 'ディレクトリ名';
CREATE TABLESPACE 表領域名;
```

-  **表領域を新規作成すると、その表領域に対応するデータファイルが指定したサイズで作成される。**

**表領域の拡張　★★★★**

- 表領域のサイズを増やす場合は、次のようにデータファイルを追加するか、または表領域のデータファイルのサイズを増やします。
  + 既存の表領域へデータファイルを追加する。
 
  + 既存のデータファイルのサイズを手動拡張する。
 
  + 既存のデータファイルの自動拡張を設定する。

- 既存の表領域へデータファイルを追加するには```ALTER TABLESPACE文```を使用します。

``` SQL
ALTER TABLESPACE 表領域名 ADD DATAFILE `データファイル名` SIZE サイズ;
```
- 既存のデータファイルのサイズを手動で拡張するには、```ALTER DATABASE文```を使用します。

```SQL
ALTER DATABASE DATAFILE 'データファイル名' RESIZE サイズ;
```

- 既存のデータファイルに自動拡張の設定を行うと、より多くの領域が必要になった場合に自動的にデータファイルのサイズが拡張されます。エクステントがさらに必要になった場合は、**NEXT句**で指定した増分サイズの領域を、**MAXSIZE句**で指定した最大サイズになるまで自動的に割り当てることができます。なお、データファイルに割り当てられるディスク領域を制限しない場合は、**UNLIMITED**を指定します。

```SQL
ALTER DATABASE DATAFILE 'データファイル名'
    AUTOEXTEND ON
    NEXT サイズ
    MAXSIZE {サイズ | UNLIMITED};
```

- 表領域の拡張以外の変更操作には、次のような操作があります。

  + 表領域使用率のアラートのしきい値を変更する。

  + 表領域のステータス(状態)をオフラインに変更する。










































## リンク

- [ディレクトリ](./../directory.md)

- 前章：[第五章 Oracleインスタンスの管理](Chapter05.md)

- 次章：[第七章 ユーザーおよびセキュリティの管理](Chapter07.md)
