# 第九章 バックアップおよびリカバリの実行

## 9.1 バックアップおよびリカバリの概要

**バックアップ、リストラ、リカバリ　★★★★★**

- `バックアップ`とは、**データを再構築するために使用できるデータベースのデータのコピー**です。

- `バックアップ`には、`物理バックアップ`と`論理バックアップ`がありますが、**試験(1Z0-065)では、特に物理バックアップについて理解しておくことが必要です**。

- バックアップの種類

|種類 |説明 |
|---- |---- |
|物理バックアップ |データファイル、制御ファイルなどの、データベースを構成する物理ファイル群のコピーを作成すること。 |
|論理バックアップ |Oracle Data Pumpを使用して表やストアドプロシージャなどの定義、データなどの論理データをバイナリファイルにエクスポートすること。後でそのバイナリファイルをデータベースにインポートすろことでリストアする。 |

- `物理バックアップ`では、`RMAN`(Recovery Manager)と呼びばれる機能を使用して、次挙げる**データベースを構成する物理ファイル群**をディスクまたはテープにコピーします。

  + `制御ファイル`

  + `アーカイブREDOログファイル`(オンラインREDOログファイルのコピー)

  + `データファイル`

  + `サーバーパラメータファイル`

- データベースの`リストア`とは、ディスクまたはテープなどのバックアップ媒体から、元の場所または新しい場所に、データベースを構成する**物理ファイル**をコピーすること。

- データベースの`リカバリ`とは、`REDOログファイル`を使用して、バックアップ作成後に実行されたデータベースへの変更し、**データ**を復旧すること。

- `アーカイブ・ログ・ファイル`名は`LOG_ARCHIVE_FORMAT初期化パラメータ`で設定ができる。

- `アーカイブ・ログ・ファイル`名に、順序番号(%s、%S)、スレッド(%t、%T)、リセットログID(%r、%R)を必須です。

|書式 |説明 |
|---- |---- |
|%s |ログ順序番号 |
|%S |0を埋め込んだログ順序番号 |
|%t |スレッド番号 |
|%T |0を埋め込んだスレッド番号 |
|%r |リセットログID |
|%R |0を埋め込んだリセットログID |
|%a |アクティブかID(省略可) |
|%d |データベースID(省略可) |

- `アーカイブ・ログ・ファイル`の保存先は`LOG_ARCHIVE_DEST初期化パラメータ`に場所を設定する。さらに、保存先として`高速リカバリ領域`を指定する場合は、`高速リカバリ領域`を示すキーワード`USE_DB_RECOVERY_FILE_DEST`を使用する。

|保存場所 |設定例 |
|---- |---- |
|ローカルファイル |LOG_ARCHIVE_DEST = 'LOCATION = /disk1/arc' |
|高速リカバリ領域 |LOG_ARCHIVE_DEST = 'LOCATION = USE_DB_RECOVERY_FILE_DEST' |

**バックアップのタイプ　★★★★★**

- `バックアップ`のタイプには「`一貫性バックアップ`」と「`非一貫性バックアップ`」の２種類がある。

- `一貫性バックアップ`とは、**コミットされたすべての変更内容がデータファイルに書き込まれている状態で取得したバックアップ**です。

- `一貫性バックアップ`は、データベースを正常にクローズし、インスタンスを停止してから取得する。`リストア`後、すぐにデータベースをオープンできる。

- `非一貫性バックアップ`とは、**データファイルに適用されていない変更がある状態で取得したバックアップ**です。

- `非一貫性バックアップ`は、データベースが**オープンしている状態**でも取得できるが、`データファイル`を`リストア`した後、`REDOログファイル`を使用して`リカバリ`を実行する必要がある。

**Oracleデータベースのリカバリ機能　★★★★★**

- Oracleデータベースで「`インスタンスリカバリ`」、「`メディアリカバリ`」、「`フラッシュバック`」３種類のリカバリ機能があります。

- `インスタンスリカバリ`は、インスタンス障害の発生時点までにコミットされていたトランザクションの変更内容を適用するように、データベースをリカバリする。

- `インスタンスリカバリ`は、インスタンス障害の発生後、データベースを再起動した際に、SMONによって**自動的に実行される**。

- `インスタンスリカバリ`が実行されるのは**データベースのオープン時**です。

- `メディアリカバリ`は、メディア障害時消失または破損した「現行のデータファイル」をリカバリする。データベースが`ARCHIVELOGモード`の場合にのみ実行できる。

- `メディアリカバリ`は次のステップで行われます。

  1. 破損したファイルをバックアップから`リストアする`。

  2. `オンラインREDOログファイル`と`アーカイブREDOログファイル`を使用して、「`リストア`した`データファイル`に適用されていないトランザクションの変更情報」を適用する。

  3. この時点の`データファイル`には、コミット済みのトランザクションとコミットされていないトランザクションのデータが混在している。

  4. `UNDOデータ`を使用して、未コミットのトランザクションがロールバックされる。

  5. `データファイル`が`リカバリ`された状態になる。

- `メディアリカバリ`は、`完全リカバリ`と`Point-in-Time　リカバリ`の２種類がある。

- `完全リカバリ`は、データを失うことなく、データベースを障害発生直前の状態まで戻す。`REDOログ`や`増分バックアップ`を使用することによって、データベースの**すべてのコミットが反映された状態へリカバリすること**です。

- `Point-in-Time　リカバリ`(不完全リカバリ)は、データベースを過去の任意の時点の状態に戻す。データベースが`MOUNT状態`で、`ARCHIVELOGモード`で稼動している場合にのみ実行できる。

- データ・ブロックを対象とした`メディアリカバリ`を**ブロック・メディアリカバリ**と言う。

- `RMAN`を使用したバックアップに表ラベルで`リカバリ`機能について、以下の**利点**がある。

  + 少数の`表`を**特定の時点まで**、`リカバリ`することができる。

  + 論理的に破損した`表`や、削除された`表`を`リカバリ`することができる。

  + `リカバリ対象`の時点が使用可能な`UNDOデータ`より古く、`フラッシュバック・テーブル`が使えない場合に利用できる。

  + `DDL操作`によって`表`の構造を変更した後に失われたデータを`リカバリ`することができる。

- `RMAN`を使用した`バックアップ`に表ラベルで`リカバリ`機能について、以下の**制限・前題条件**がある。

  + `SYSスキーマ`に属する`表`の`リカバリ`はできない。
  
  + `SYSTEM表領域`および`SYSAUX表領域`の`表`の`リカバリ`はできない。

  + 停止中のデータベース上の`表`の`リカバリ`はできない。

  + `ARCHIVELOGモード`で稼働する必要がある。

  + `リカバリ`に指定した時点で対象の`表`が存在し、`RMAN`で取得した`バックアップ`が存在する必要がある。

- `フラッシュバック`機能

|機能 |説明 |
|---- |---- |
|フラッシュバック問合せ |ターゲット時刻を指定してデータベースに問合せを行い、指定した時点の問合せ結果を参照する。 |
|フラッシュバージョン問合せ |指定した期間内に１つ以上の表に存在していたすべての行のすべてのバージョンの結果を参照する。 |
|フラッシュバックトランザクション問合せ |１つのトランザクション、または指定した期間内のすべてのトランザクションによて行われ変更の結果を参照する |
|フラッシュバック表 |表を過去の指定の時点に戻る |
|フラッシュバックドロップ |ユーザーが表を削除すると、その表はごみ箱に入れられる。削除した表とその依頼オブジェクトをごみ箱から元に戻すことができる。 |
|フラッシュバックデータベース |データベースを以前の時点まで戻し、データベースのPoint-in-Timeリカバリを効率的に行う。 |

- Oracleデータベースのリカバリ機能

|要件 |リカバリ機能 |
|---- |---- |
|インスタンス障害からの回復 |インスタンスリカバリ(クラッシュリカバリ) |
|メディア障害からの回復 |メディアリカバリ |
|ユーザーエラーからのリカバリ |フラッシュバック機能 |

**バックアップおよびリカバリを自動管理するためのデータベース構成　★★★★**

- `高速リカバリ領域`は、各ファイルの`バックアップ`など、`バックアップ`／`リカバリ`に関するファイルを**自動管理**するための領域である。

- 管理者はデータベースに次のように構成を行います。

  1. `バックアップ`用に`高速リカバリ領域`を構成する。

  2. `高速リカバリ領域`を`アーカイブREDOログ`の保存先にする。

  3. `オンラインバックアップ`を実行できるように、データベースを**ARCHIVELOGモード**で運用する。

- `高速リカバリ領域`は十分大きなサイズにする。目安は、「データファイルの完全バックアップを２つ、リカバリをしたい期間内の任意の時点のデータベースをリストアするために必要な増分バックアップ、およびアーカイブREDOファイルが格納できるサイズ。」

- `高速リカバリ領域`の場所は、**DB_RECOVERY_FILE_DEST初期化パラメータ**、`高速リカバリ領域`のサイズは**DB_RECOVERY_FILE_DEST_SIZE初期化パラメータ**で指定する。

- データベースモードは次のいずれかとなる。

  + NOARCHIVELOGモード

    * データベースのクロース中に作成したデータベース全体のバックアップを使ったリストア。

    * オンラインでの表領域のバックアップを実行できない。

  + ARCHIVELOGモード

    * メディア障害やディスク障害が発生してもコミットされたすべてのトランザクションをりか張りできる。

    * データベースオープンした状態で作成したバックアップを使用できる。

    * オンラインでの表領域のバックアップを実行できる。

- `DBCA`でデフォルトのテンプレートを使用してデフォルトの設定でデータベースを作成すると、`NOARCHIVELOGモード`になる。

## 9.2 バックアップの作成および管理

**バックアップの分類　★★★**

- `バックアップファイル`によるタイプ分け

|ファイルの種類 |説明 |
|---- |---- |
|イメージコピー |OSレベルの`データファイル`、`制御ファイル`、`アーカイブREDOログファイル`などのコピー |
|バックアップセット |`RMAN`の**BACKUPコマンド**によって作成される`RMAN`固有の形式の`バックアップ`。<br>データの格納に使用されているブロックのみがバックアップセットに含められる。 |

- バックアップ対象によるタイプ分け

|バックアップ対象 |説明 |
|---- |---- |
|データファイルの全体バックアップ |データファイル全体 |
|データファイルの増分バックアップ |データファイルのバックアップ間で変更があったブロックのみが含まれる |
|全体バックアップ |バックアップ時点でのデータベース全体の内容が含まれる |

**バックアップ設定の構成　★★★★**

- `RMAN`では、`バックアップ`に関する設定および`バックアップ`方針を構成できる。

- 現在の`RMAN`の設定内容を表示するには、`RMAN`プロンプトで`SHOW ALL`コマンドを実行する。

- `バックアップ`をディスクに格納するように設定する場合は、次のコマンドを実行する。

```SQL
CONFIGURE DEFAULT DEVICE TYPE TO DISK;
```

- `データファイル`の`バックアップ`時に`制御ファイル`や`サーバーパラメータファイル`も自動的に`バックアップ`する場合は、次のコマンドを実行する。

```SQL
CONFIGURE CONTROLFILE AUTOBACKUP ON;
```

**データベース全体のバックアップ　★★★**

- データベース全体の`バックアップ`では、次のファイル群がバックアップされます。

  + すべての`データファイル`

  + `制御ファイル`

  + `アーカイブREDOログファイル`

  + `サーバーパラメータファイル`

- データベース全体の`バックアップ`を作成すると、データベースのすべての`データファイル`、`制御ファイル`、`アーカイブREDOログファイル`、`SPFILE`がイメージコピーまたは`バックアップ`セットとして格納される。この一連のファイルにより、完全に`リカバリ`できる。

**推奨バックアップ計画の使用　★★★**

- Oracle社の`推奨バックアップ計画`を使用すると、データベースの変更を`アーカイブREDOログファイル`から`データファイル`に適用するよりも高速に`リカバリ`することができます。

- `推奨バックアップ計画`では、`増分バックアップ機能`および`増分更新バックアップ機能`が利用される。

- `増分更新バックアップ機能`とは、`データファイル`のイメージコピーをレベル１増分`バックアップ`でロールフォワードする機能である。

**バックアップの管理　★★★★**

- `バックアップ`のステータス値

|ステータス値 |説明 |
|---- |---- |
|AVAILABLE<br>使用可能 |`REAMリポジトリ`に記録されている`バックアップ`が、ディスクまたはテープに存在し、使用できることを意味する。 |
|EXPIRED<br>期限切れ |`REAMリポジトリ`に記録がされているにもかかわらず、すでにディスクまたはテープにバックアップが存在しないことを意味する。 |
|UNAVAILABLE<br>使用不可 |外部に保管されているテープやマウントされていないディスクにバックアップが存在し、一時的に使用できないことを意味する。 |

- `REAM`による`バックアップ`のメンテナンス機能には次のものがある。

  + `REAMリポジトリ`に記録されたバックアップのリスト表示

  + リポジトリのクロスチェックを行って、リポジトリにリストされている**バックアップファイルの有無**や、**アクセス可否**かを識別する。アクセスできなかったバックアップには「EXPIRED」(期限切れ)のマークが付く。

  + `REAMリポジトリ`から期限切れバックアップのレコードを削除する。

  + `REAMリポジトリ`とディスクから、不要なったバックアップを削除する。

## 9.3 リカバリの実行

**Oracle社推奨のリカバリ　★★★★★**

- Oracle社推奨の`リカバリ`方法は｢**データリカバリアドバイザ**｣というツールを使用する方法です。

- データ障害が検出されると、その情報は`ADR`(自動診断リポジトリ)に記録される。

- `データリカバリアドバイザ`は`ADR`の情報を使用して、修復アドバイザを生成し、障害の修復を実行する。

- 修復アドバイザの生成と障害を実行するには、REAMで次の手順を実行する。

  1. LIST FAILURE

  2. ADVISE FAILURE

  3. REPAIR FAILURE

- **データファイルを修復する**には、`制御ファイル`が読み込まれている状態でなければならない、したがって、`制御ファイル`がデータベースの`MOUNT状態`で起動してリカバリを実施する。

**フラッシュバック表　★★★★★**

- `フラッシュバック表`を使用すると、`バックアップ`をリストせずに、`表`を過去のある時点まで`リカバリ`できる。

- `フラッシュバック表`を実行するには、事前にその表の行移動を可能にしておく必要がある。

- データベース管理者に依頼せずに、ユーザーが自分で行う場合は、`FLASHBACK TABLE`システム権限とオブジェクトに対するSELECT, INSTER, DELETE, ALTERオブジェクト権限が必要である。

**フラッシュバックロップ　★★★**

- `フラッシュバックロップ`は、**表の削除処理を無効にして、削除した表を元に戻す機能**です。

## リンク

- [ディレクトリ](./../directory.md)

- 前章：[第八章 スキーマオブジェクトの管理](Chapter08.md)

- 次章：[第十章 データベースの監視およびアドバイザの使用](Chapter10.md)
