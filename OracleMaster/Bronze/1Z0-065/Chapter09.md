# 第九章 バックアップおよびリカバリの実行

## 9.1 バックアップおよびリカバリの概要

**バックアップ、リストラ、リカバリ　★★★★★**

- `バックアップ`とは、**データを再構築するために使用できるデータベースのデータのコピー**です。

- `バックアップ`には、`物理バックアップ`と`論理バックアップ`がありますが、**試験(1Z0-065)では、特に物理バックアップについて理解しておくことが必要です**。

- バックアップの種類

|種類 |説明 |
|---- |---- |
|物理バックアップ |データファイル、制御ファイルなどの、データベースを構成する物理ファイル群のコピーを作成すること。 |
|論理バックアップ |Oracle Data Pumpを使用して表やストアドプロシージャなどの定義、データなどの論理データをバイナリファイルにエクスポートすること。後でそのバイナリファイルをデータベースにインポートすろことでリストアする。 |

- データベースの`リストア`とは、ディスクまたはテーブルなどのバックアップ媒体から、元の場所または新しい場所に、データベースを構成する物理ファイルをコピーすること。

- データベースの`リカバリ`とは、REDOログファイルを使用して、バックアップ作成後に実行されたデータベースへの変更し、データを復旧すること。

**バックアップのタイプ　★★★★★**

- バックアップのタイプには「`一貫性バックアップ`」と「`非一貫性バックアップ`」の２種類がある。

- `一貫性バックアップ`は、データベースを正常にクローズし、インスタンスを停止してから取得する。リストア後、すぐにデータベースをオープンできる。

- `非一貫性バックアップ`は、データベースがオープンしている状態でも取得できるが、データファイルをリストアした後、REDOログファイルを使用してリカバリを実行する必要がある。

**Oracleデータベースのリカバリ機能　★★★★★**

- Oracleデータベースで「`インスタンスリカバリ`」、「`メディアリカバリ`」、「`フラッシュバック`」３種類のリカバリ機能があります。

- `インスタンスリカバリ`は、インスタンス障害の発生時点までにコミットされていたトランザクションの変更内容を仕様適用するように、データベースをリカバリする。

- `インスタンスリカバリ`は、インスタンス障害の発生後、データベースを再起動した際に、SMONによって**自動的に実行される**。

- `メディアリカバリ`は、メディア障害時消失または破損した「現行のデータファイル」をリカバリする。

- `メディアリカバリ`は、`完全リカバリ`と`Point-in-Time　リカバリ`の２種類がある。

- `完全リカバリ`は、データを失うことなく、データベースを障害発生直前の状態まで戻す。

- `Point-in-Time　リカバリ`(不完全リカバリ)は、データベースを過去の任意の時点の状態に戻す。

- `フラッシュバック`機能

|機能 |説明 |
|---- |---- |
|フラッシュバック問合せ |ターゲット時刻を指定してデータベースに問合せを行い、指定した時点の問合せ結果を参照する。 |
|フラッシュバージョン問合せ |指定した期間内に１つ以上の表に存在していたすべての行のすべてのバージョンの結果を参照する。 |
|フラッシュバックトランザクション問合せ |１つのトランザクション、または指定した期間内のすべてのトランザクションによて行われ変更の結果を参照する |
|フラッシュバック表 |表を過去の指定の時点に戻る |
|フラッシュバックドロップ |ユーザーが表を削除すると、その表はごみ箱に入れられる。削除した表とその依頼オブジェクトをごみ箱から元に戻すことができる。 |
|フラッシュバックデータベース |データベースを以前の時点まで戻し、データベースのPoint-in-Timeリカバリを効率的に行う。 |

- Oracleデータベースのリカバリ機能

|要件 |リカバリ機能 |
|---- |---- |
|インスタンス障害からの回復 |インスタンスリカバリ(クラッシュリカバリ) |
|メディア障害からの回復 |メディアリカバリ |
|ユーザーエラーからのリカバリ |フラッシュバック機能 |

**バックアップおよびリカバリを自動管理するためのデータベース構成　★★★★**

- 高速リカバリ領域は、各ファイルのバックアップなど、バックアップ／リカバリに関するファイルを自動管理するための領域である。

- 高速リカバリ領域は十分大きなサイズにする。目安は、「データファイルの完全バックアップを２つ、リカバリをしたい期間内の任意の時点のデータベースをリストアするために必要な増分バックアップ、およびアーカイブREDOファイルが格納できるサイズ。」

- 高速リカバリ領域の場所は、`DB_RECOVERY_FILE_DEST初期化パラメータ`、高速リカバリ領域のサイズは`DB_RECOVERY_FILE_DEST_SIZE初期化パラメータ`で指定する。

- データベースモードは次のいずれかとなる。

  + NOARCHIVELOGモード

  + ARCHIVELOGモード

## 9.2 バックアップの作成および管理

**バックアップの分類　★★★**

- バックアップファイルによるタイプ分け

|ファイルの種類 |説明 |
|---- |---- |
|イメージコピー |OSレベルのデータファイル、制御ファイル、アーカイブREDOログファイルなどのコピー |
|バックアップセット |RMANのBACKUPコマンドによって作成されるRMAN固有の形式のバックアップ。<br>データの格納に使用されているブロックのみがバックアップセットに含められる。 |

**バックアップ設定の構成　★★★★**

- `RMAN`では、バックアップに関する設定およびバックアップ方針を構成できる。

- `RMAN`プロンプトで`SHOW ALL`コマンドを実行します。

- バックアップをディスクに格納するように設定する場合は、次のコマンドを実行する。

```SQL
CONFIGURE DEFAULT DEVICE TYPE TO DISK;
```

- データファイルのバックアップ時に制御ファイルやサーバーパラメータファイルも自動的にバックアップする場合は、次のコマンドを実行する。

```SQL
CONFIGURE CONTROLFILE AUTOBACKUP ON;
```

**データベース全体のバックアップ　★★★**

- データベース全体のバックアップでは、次のファイル群がバックアップされます。

  + すべてのデータファイル

  + 制御ファイル

  + アーカイブREDOログファイル

  + サーバーパラメータファイル

- データベース全体のバックアップを作成すると、データベースのすべてのデータファイル、制御ファイル、アーカイブREDOログファイル、SPFILEがイメージコピーまたはバックアップセットとして格納される。この一連のファイルにより、完全にリカバリできる。

**推奨バックアップ計画の使用　★★★**

- Oracle社の推奨バックアップ計画を使用すると、データベースの変更をアーカイブREDOログファイルからデータファイルに適用するよりも高速にリカバリすることができます。

- 推奨バックアップ計画では、増分バックアップおよび増分更新バックアップ機能が利用される。

- 増分更新バックアップ機能とは、データファイルのイメージコピーをレベル１増分バックアップでロールフォワードする機能である。

**バックアップの管理　★★★★**

- バックアップのステータス値

|ステータス値 |説明 |
|---- |---- |
|AVAILABLE |使用可能。REAMリポジトリに記録されているバックアップが、ディスクまたはテープに存在し、使用できることを意味する。 |
|EXPIRED |期限切れ。REAM\リポジトリに記録がされているにもかかわらず、すでにディスクまたはテープにバックアップが存在しないことを意味する。 |
|UNAVAILABLE |使用不可。外部に保管されているテープやマウントされていないディスクにバックアップが存在し、一時的に使用できないことを意味する。 |

- REAMによるバックアップのメンテナンス機能には次のものがある。

  + REAMリポジトリに記録されたバックアップのリスト表示

  + リポジトリのクロスチェックを行って、リポジトリにリストされているバックアップの有無や、アクセス可否かを識別する。アクセスできなかったバックアップには「EXPIRED」(期限切れ)のマークが付く。

  + REAMリポジトリから期限切れバックアップのレコードを削除する。

  + REAMリポジトリとディスクから、不要なったバックアップを削除する。

## 9.3 リカバリの実行

**Oracle社推奨のリカバリ　★★★★★**

- Oracle社推奨のリカバリ方法は｢データリカバリアドバイザ｣というツールを使用する方法です。

- データ障害が検出されると、その情報はADR(自動診断リポジトリ)に記録される。

- データリカバリアドバイザはADRの情報を使用して、修復アドバイザを生成し、障害の修復を実行する。

- 修復アドバイザの生成と障害を実行するには、REAMで次の手順を実行する。

  + LIST FAILURE

  + ADVISE FAILURE

  + REPAIR FAILURE
  
**フラッシュバック表　★★★★★**

- フラッシュバック表を使用すると、バックアップをリストせずに、表を過去のある時点までリカバリできる。

- フラッシュバック表を実行するには、事前にその表の行移動を可能にしておく必要がある。

- データベース管理者に依頼せずに、ユーザーが自分で行う場合は、FLASHBACK TABLEシステム権限とオブジェクトに対するSELECT, INSTER, DELETE, ALTERオブジェクト権限が必要である。

**フラッシュバックロップ　★★★**

- フラッシュバックロップは、**表の削除処理を無効にして、削除した表を元に戻す機能**です。

## リンク

- [ディレクトリ](./../directory.md)

- 前章：[第八章 スキーマオブジェクトの管理](Chapter08.md)

- 次章：[第十章 データベースの監視およびアドバイザの使用](Chapter10.md)
